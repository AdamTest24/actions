name: "Validate Pull Request"

on:
  workflow_run:
    workflows: ["Receive Pull Request"]

jobs:
  test-pr-artifact:
    runs-on: ubuntu-20.04
    if: >
      ${{ github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v2

      - name: 'Download artifact'
        uses: actions/github-script@v3.1.0
        with:
          script: |
            var artifacts = await github.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: ${{github.event.workflow_run.id }},
            });
            var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "pr"
            })[0];
            var download = await github.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            var fs = require('fs');
            fs.writeFileSync('${{github.workspace}}/pr.zip', Buffer.from(download.data));
            
      - name: "Get PR Number"
        id: get-pr
        run: |
          unzip pr.zip
          cho "::set-output name=NUM::$(cat ./NUM)"
      
      - name: "Check PR"
        id: check-pr
        uses: zkamvar/actions/check-pr@main
        with:
          pr: ${{ steps.get-pr.outputs.NUM }}
          repo: ${{ github.repository }}
          sha: ${{ github.events.workflow_run.head_commit.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: "Run if valid"
        if: ${{ steps.check-pr.outputs.VALID }}
        run: echo "It's valid!"
